package com.tms.servlets;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.*;
import java.io.IOException;
import java.io.PrintWriter;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

import com.tms.beans.TrainException;
import com.tms.beans.UserBean;
import com.tms.constant.UserRole;
import com.tms.service.UserService;
import com.tms.service.impl.UserServiceImpl;
import com.tms.utils.TrainUtil;

@SuppressWarnings("serial")
@WebServlet("/changeuserpwd")
public class ChangeUserPwd extends HttpServlet {
    private UserService userService = new UserServiceImpl(UserRole.CUSTOMER);

    protected void doPost(HttpServletRequest req, HttpServletResponse res) throws IOException, ServletException {
        res.setContentType("text/html");
        UserBean currentUser = TrainUtil.getCurrentCustomer(req);
        String cp = req.getContextPath();

        try {
            String u_Name = req.getParameter("username");
            String oldPW  = req.getParameter("oldpassword");
            String newPW  = req.getParameter("newpassword");

            if (!currentUser.getMailId().equals(u_Name)) {
                String err = URLEncoder.encode("Invalid username!", StandardCharsets.UTF_8);
                res.sendRedirect(cp + "/changeuserpassword?msg=" + err + "&msgType=danger");
                return;
            }
            if (!currentUser.getPWord().equals(oldPW)) {
                String err = URLEncoder.encode("Wrong old password!", StandardCharsets.UTF_8);
                res.sendRedirect(cp + "/changeuserpassword?msg=" + err + "&msgType=danger");
                return;
            }

            // update
            currentUser.setPWord(newPW);
            String outcome = userService.updateUser(currentUser);
            if ("SUCCESS".equalsIgnoreCase(outcome)) {
                // clear session & show standalone success centered
                TrainUtil.logout(res);
                PrintWriter pw = res.getWriter();
                pw.println("<!DOCTYPE html><html><head>");
                pw.println("<meta charset='UTF-8'><title>Password Changed</title>");
                pw.println("<link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' rel='stylesheet'>");
                pw.println("</head><body>");
                pw.println("<div class='container d-flex align-items-center justify-content-center' style='min-height:100vh;'>");
                pw.println("  <div class='alert alert-success text-center'>");
                pw.println("    Your password has been changed successfully.<br>");
                pw.println("    <a href='" + cp + "/UserLogin.jsp' class='alert-link'>Click here to log in</a>.");
                pw.println("  </div>");
                pw.println("</div>");
                pw.println("</body></html>");
            } else {
                String err = URLEncoder.encode("Failed to update password. Try again.", StandardCharsets.UTF_8);
                res.sendRedirect(cp + "/changeuserpassword?msg=" + err + "&msgType=danger");
            }

        } catch (Exception e) {
            throw new TrainException(422, this.getClass().getName() + "_FAILED", e.getMessage());
        }
    }
}
